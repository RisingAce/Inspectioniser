<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>InspectSpace ‚Ä¢ Property Inspection Tool</title>
  
  <!-- External dependencies -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/interact.js/1.10.17/interact.min.js"></script>
  <!-- Mammoth for docx parsing (CDN) -->
  <script src="https://unpkg.com/mammoth@1.5.4/dist/mammoth.browser.min.js"></script>

  <style>
    /* === GLOBAL STYLES === */
    :root {
      /* Light mode colors */
      --bg-primary: #f0f0ea;
      --bg-secondary: #e8e8dd;
      --bg-window: #ffffff;
      --text-primary: #232320;
      --text-secondary: #46463e;
      --accent-primary: #6d8a96;
      --accent-secondary: #9bc995;
      --accent-tertiary: #e7a75c;
      --border-color: #2c2c2a;
      --window-header: #7c90ac;
      --window-shadow: rgba(0, 0, 0, 0.2);
      --window-border: #242424;
      --success: #66a182;
      --error: #d35d6e;
      --warning: #e7a75c;
      
      /* Size variables */
      --window-radius: 6px;
      --border-width: 2px;
      --button-radius: 5px;
      
      /* Typography */
      --font-heading: 'Arial Black', Gadget, sans-serif;
      --font-body: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      
      /* Transitions */
      --transition-speed: 0.2s;
    }

    [data-theme="dark"] {
      --bg-primary: #212125;
      --bg-secondary: #2c2c30;
      --bg-window: #343438;
      --text-primary: #e8e8e0;
      --text-secondary: #b8b8b0;
      --accent-primary: #7c9eb3;
      --accent-secondary: #86b375;
      --accent-tertiary: #e7b979;
      --border-color: #5c5c5a;
      --window-header: #546180;
      --window-shadow: rgba(0, 0, 0, 0.4);
      --window-border: #4a4a4a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: var(--font-body);
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-size: 16px;
      line-height: 1.5;
      overflow: hidden;
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    /* === TYPOGRAPHY === */
    h1, h2, h3, h4, h5 {
      font-family: var(--font-heading);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 900;
    }

    h1 {
      font-size: 3.2rem;
      line-height: 1.2;
      margin-bottom: 1rem;
    }

    h2 {
      font-size: 2.2rem;
      margin-bottom: 1rem;
    }

    h3 {
      font-size: 1.6rem;
      margin-bottom: 0.75rem;
    }

    p {
      margin-bottom: 1rem;
    }

    /* === BUTTONS === */
    button, .btn {
      font-family: var(--font-heading);
      font-weight: bold;
      font-size: 1rem;
      text-transform: uppercase;
      padding: 0.75rem 1.5rem;
      background-color: var(--accent-primary);
      color: var(--bg-primary);
      border: var(--border-width) solid var(--border-color);
      border-radius: var(--button-radius);
      cursor: pointer;
      transition: all var(--transition-speed);
      box-shadow: 4px 4px 0 var(--border-color);
      margin: 0.5rem;
      letter-spacing: 0.05em;
    }

    button:hover, .btn:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--border-color);
      filter: brightness(1.1);
    }

    button:active, .btn:active {
      transform: translate(4px, 4px);
      box-shadow: none;
      filter: brightness(0.9);
    }

    .start-btn {
      font-size: 1.2rem;
      background-color: var(--accent-secondary);
      padding: 1rem 2rem;
      box-shadow: 5px 5px 0 var(--border-color);
    }

    .start-btn:hover {
      transform: translate(2px, 2px);
      box-shadow: 3px 3px 0 var(--border-color);
    }

    .start-btn:active {
      transform: translate(5px, 5px);
      box-shadow: none;
    }

    /* === FORMS === */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-family: var(--font-heading);
      font-weight: bold;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      font-size: 0.9rem;
      letter-spacing: 0.05em;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 0.75rem;
      background-color: var(--bg-window);
      border: var(--border-width) solid var(--border-color);
      border-radius: 4px;
      font-family: var(--font-body);
      font-size: 1rem;
      color: var(--text-primary);
      transition: all var(--transition-speed);
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(109, 138, 150, 0.3);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* === TOGGLE SWITCH === */
    .toggle {
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      padding: 0.5rem;
      border-radius: 4px;
      transition: all var(--transition-speed);
    }

    .toggle:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 24px;
      background-color: var(--bg-secondary);
      border-radius: 12px;
      margin-right: 10px;
      transition: all var(--transition-speed);
      border: var(--border-width) solid var(--border-color);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background-color: var(--bg-primary);
      top: 1px;
      left: 1px;
      transition: all var(--transition-speed);
      border: var(--border-width) solid var(--border-color);
    }

    .toggle.active .toggle-switch {
      background-color: var(--accent-primary);
    }

    .toggle.active .toggle-switch::after {
      transform: translateX(16px);
      background-color: var(--bg-window);
    }

    /* === LAYOUT === */
    .app {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .start-screen {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      background-color: var(--bg-primary);
      transition: opacity var(--transition-speed), transform var(--transition-speed);
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
    }

    .start-screen.active {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .start-screen-content {
      max-width: 800px;
      width: 100%;
      text-align: center;
      background-color: var(--bg-window);
      padding: 3rem;
      border-radius: 10px;
      border: var(--border-width) solid var(--border-color);
      box-shadow: 8px 8px 0 var(--border-color);
    }

    .logo {
      font-size: 3.5rem;
      margin-bottom: 1rem;
      transform: scale(1);
      transition: transform 0.3s;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    .saved-reports {
      margin-top: 3rem;
      text-align: left;
    }

    .report-list {
      list-style: none;
      padding: 0;
      margin: 0;
      background-color: var(--bg-secondary);
      border: var(--border-width) solid var(--border-color);
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
    }

    .report-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background-color var(--transition-speed);
    }

    .report-item:last-child {
      border-bottom: none;
    }

    .report-item:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .report-item-empty {
      padding: 1rem;
      text-align: center;
      color: var(--text-secondary);
    }

    .report-item-info {
      flex: 1;
    }

    .report-item-address {
      font-weight: bold;
      margin-bottom: 0.25rem;
    }

    .report-item-date {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .report-item-actions {
      display: flex;
      gap: 0.5rem;
    }

    .report-item-btn {
      background: none;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-speed);
      padding: 0;
      box-shadow: 2px 2px 0 var(--border-color);
    }

    .report-item-btn:hover {
      transform: translate(1px, 1px);
      box-shadow: 1px 1px 0 var(--border-color);
    }

    .report-item-btn.load-btn {
      background-color: var(--accent-primary);
      color: var(--bg-window);
    }

    .report-item-btn.delete-btn {
      background-color: var(--error);
      color: var(--bg-window);
    }

    .main-interface {
      width: 100%;
      height: 100%;
      opacity: 0;
      transform: scale(0.95);
      transition: opacity var(--transition-speed), transform var(--transition-speed);
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }

    .main-interface.active {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }

    .desktop {
      width: 100%;
      height: calc(100% - 40px);
      position: relative;
      overflow: hidden;
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23bdbdbd' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
    }

    .toolbar {
      width: 100%;
      height: 40px;
      background-color: var(--window-header);
      border-bottom: var(--border-width) solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 1rem;
      color: var(--bg-window);
    }

    .toolbar-title {
      font-family: var(--font-heading);
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .toolbar-actions {
      display: flex;
      gap: 0.5rem;
    }

    .toolbar-btn {
      background: none;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-speed);
      padding: 0;
      box-shadow: 2px 2px 0 var(--border-color);
      color: var(--bg-window);
    }

    .toolbar-btn:hover {
      transform: translate(1px, 1px);
      box-shadow: 1px 1px 0 var(--border-color);
      background-color: rgba(255, 255, 255, 0.1);
    }

    .settings-panel {
      position: absolute;
      top: 40px;
      right: 0;
      width: 300px;
      background-color: var(--bg-window);
      border-left: var(--border-width) solid var(--border-color);
      border-bottom: var(--border-width) solid var(--border-color);
      border-bottom-left-radius: 10px;
      max-height: 0;
      overflow: hidden;
      transition: max-height var(--transition-speed);
      z-index: 200;
      box-shadow: -4px 4px 0 var(--window-shadow);
    }

    .settings-panel.active {
      max-height: 600px;
    }

    .settings-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--text-secondary);
      transition: color var(--transition-speed);
    }

    .settings-close:hover {
      color: var(--text-primary);
    }

    .settings-section {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .settings-section:last-child {
      border-bottom: none;
    }

    .settings-title {
      margin-bottom: 1rem;
      font-family: var(--font-heading);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .font-size-controls {
      display: flex;
      gap: 0.5rem;
    }

    .canvas-tool {
      padding: 0.5rem 1rem;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      transition: all var(--transition-speed);
    }

    .canvas-tool:hover {
      background-color: var(--accent-primary);
      color: var(--bg-window);
    }

    /* === WINDOWS === */
    .window {
      position: absolute;
      background-color: var(--bg-window);
      border: var(--border-width) solid var(--window-border);
      border-radius: var(--window-radius);
      box-shadow: 6px 6px 0 var(--window-shadow);
      min-width: 300px;
      min-height: 200px;
      max-width: calc(100% - 20px);
      max-height: calc(100% - 60px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.3s, opacity 0.3s;
      user-select: none;
    }

    .window-header {
      background-color: var(--window-header);
      padding: 0 1rem;
      height: 35px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: grab;
      border-bottom: var(--border-width) solid var(--window-border);
    }

    .window-title {
      color: var(--bg-window);
      font-family: var(--font-heading);
      font-size: 0.9rem;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .window-controls {
      display: flex;
      gap: 8px;
    }

    .window-control {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
      border: 1px solid var(--window-border);
    }

    .window-close {
      background-color: #ff5f56;
    }

    .window-minimize {
      background-color: #ffbd2e;
    }

    .window-maximize {
      background-color: #27c93f;
    }

    .window-close:hover::after,
    .window-close:hover::before {
      content: '';
      position: absolute;
      width: 9px;
      height: 1px;
      background-color: var(--window-border);
      top: 6px;
      left: 2px;
    }

    .window-close:hover::after {
      transform: rotate(45deg);
    }

    .window-close:hover::before {
      transform: rotate(-45deg);
    }

    .window-minimize:hover::after {
      content: '';
      position: absolute;
      width: 9px;
      height: 1px;
      background-color: var(--window-border);
      top: 6px;
      left: 2px;
    }

    .window-maximize:hover::after,
    .window-maximize:hover::before {
      content: '';
      position: absolute;
      background-color: var(--window-border);
    }

    .window-maximize:hover::after {
      width: 7px;
      height: 7px;
      border: 1px solid var(--window-border);
      top: 2px;
      left: 2px;
      background-color: transparent;
    }

    .window-content {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
    }

    .window.active {
      box-shadow: 8px 8px 0 var(--window-shadow);
    }

    .window.minimized .window-content {
      display: none;
    }

    .window.maximized {
      width: 100% !important;
      height: calc(100% - 40px) !important;
      top: 0 !important;
      left: 0 !important;
      border-radius: 0;
    }

    /* === ROOM LIST === */
    .room-list {
      list-style: none;
      padding: 0;
      margin: 0 0 1.5rem 0;
      background-color: var(--bg-secondary);
      border: var(--border-width) solid var(--border-color);
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      transition: background-color 0.3s;
    }

    .room-list.drag-over {
      background-color: rgba(150, 200, 150, 0.2);
      border-color: var(--accent-secondary);
    }

    .room-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background-color var(--transition-speed);
    }

    .room-item:last-child {
      border-bottom: none;
    }

    .room-item:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .room-item.urgent {
      border-left: 5px solid var(--error);
      padding-left: calc(1rem - 5px);
    }

    .room-item-empty {
      padding: 1rem;
      text-align: center;
      color: var(--text-secondary);
    }

    .room-name {
      font-weight: bold;
    }

    .room-actions {
      display: flex;
      gap: 0.5rem;
    }

    .room-btn {
      background: none;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-speed);
      padding: 0;
      box-shadow: 2px 2px 0 var(--border-color);
    }

    .room-btn:hover {
      transform: translate(1px, 1px);
      box-shadow: 1px 1px 0 var(--border-color);
    }

    .room-btn.edit-btn {
      background-color: var(--accent-primary);
      color: var(--bg-window);
    }

    .room-btn.delete-btn {
      background-color: var(--error);
      color: var(--bg-window);
    }

    .add-room {
      background-color: var(--accent-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all var(--transition-speed);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 2px 2px 0 var(--border-color);
    }

    .add-room:hover {
      transform: translate(1px, 1px);
      box-shadow: 1px 1px 0 var(--border-color);
    }

    /* === ROOM TEMPLATE PALETTE === */
    .template-area {
      display: flex;
      gap: 1rem;
    }

    .template-palette {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      background-color: var(--bg-secondary);
      border: var(--border-width) solid var(--border-color);
      border-radius: 5px;
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
      width: 200px;
      min-width: 200px;
    }

    .template-item {
      background-color: var(--accent-primary);
      color: var(--bg-window);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: var(--border-width) solid var(--border-color);
      box-shadow: 2px 2px 0 var(--border-color);
      cursor: grab;
      transition: transform 0.2s;
      user-select: none;
    }

    .template-item:hover {
      transform: scale(1.02);
    }

    /* === RATING === */
    .rating {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .rating-slider {
      flex: 1;
      appearance: none;
      height: 8px;
      background-color: var(--bg-secondary);
      border-radius: 4px;
      outline: none;
      border: var(--border-width) solid var(--border-color);
    }

    .rating-slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: var(--accent-primary);
      border: var(--border-width) solid var(--border-color);
      cursor: pointer;
    }

    .rating-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: var(--accent-primary);
      border: var(--border-width) solid var(--border-color);
      cursor: pointer;
    }

    .rating-value {
      font-weight: bold;
      min-width: 40px;
    }

    /* === DROPZONE === */
    .dropzone {
      border: 2px dashed var(--border-color);
      border-radius: 5px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all var(--transition-speed);
      background-color: var(--bg-secondary);
      color: var(--text-secondary);
    }

    .dropzone:hover, .dropzone.active {
      background-color: var(--bg-primary);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }

    /* === PHOTO PREVIEWS === */
    .photo-previews {
      margin-top: 1rem;
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }

    .photo-item {
      position: relative;
      border: var(--border-width) solid var(--border-color);
      border-radius: 5px;
      overflow: hidden;
      aspect-ratio: 1;
    }

    .image-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-speed);
      padding: 0;
    }

    .photo-delete-btn:hover {
      background-color: var(--error);
      transform: scale(1.1);
    }

    /* === SIGNATURE CANVAS === */
    .signature-canvas {
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background-color: white;
      cursor: crosshair;
    }

    .canvas-tools {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      justify-content: flex-end;
    }

    /* === SUMMARY === */
    .summary-list {
      list-style: none;
      padding: 0;
      margin: 1rem 0;
      background-color: var(--bg-secondary);
      border: var(--border-width) solid var(--border-color);
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
    }

    .summary-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-item.urgent {
      border-left: 5px solid var(--error);
      padding-left: calc(1rem - 5px);
    }

    .urgent-badge {
      background-color: var(--error);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    #qrcode-container {
      padding: 1rem;
      background-color: white;
      border-radius: 5px;
      border: var(--border-width) solid var(--border-color);
      box-shadow: 4px 4px 0 var(--window-shadow);
      display: inline-block;
    }

    /* === ANIMATIONS === */
    .animate-pop {
      animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .animate-shake {
      animation: shake 0.3s cubic-bezier(0.36, 0.07, 0.19, 0.97);
    }

    @keyframes pop {
      0% { transform: scale(0.9); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
    }

    /* === FONT SIZES === */
    .font-size-1 {
      font-size: 14px;
    }

    .font-size-2 {
      font-size: 16px;
    }

    .font-size-3 {
      font-size: 18px;
    }

    /* === HIGH CONTRAST === */
    .high-contrast {
      --accent-primary: #0066cc;
      --accent-secondary: #00994c;
      --accent-tertiary: #cc6600;
      --error: #cc0000;
      --warning: #cc6600;
      --success: #007744;
      --text-primary: #000000;
      --text-secondary: #333333;
      --border-color: #000000;
      --border-width: 2px;
    }

    /* === DARK MODE === */
    .dark-mode {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2a2a2a;
      --bg-window: #333333;
      --text-primary: #e0e0e0;
      --text-secondary: #aaaaaa;
      --accent-primary: #5c9ead;
      --accent-secondary: #7abf8e;
      --accent-tertiary: #f0a868;
      --border-color: #555555;
      --window-header: #444455;
      --window-shadow: rgba(0, 0, 0, 0.3);
      --window-border: #666666;
    }

    /* === RESPONSIVE (MOBILE) === */
    @media (max-width: 850px) {
      .template-area {
        display: flex;
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      .start-screen-content {
        padding: 1.5rem;
      }
      h1 {
        font-size: 2rem;
      }
      .logo {
        font-size: 2.5rem;
      }
      .form-group {
        margin-bottom: 1rem;
      }
      .photo-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
      .window {
        max-width: 100%;
        width: calc(100% - 20px) !important;
      }
    }
  </style>

</head>
<body>
  <div id="app" class="app">
    <!-- Start Screen -->
    <div id="start-screen" class="start-screen active"></div>
    
    <!-- Main Interface -->
    <div id="main-interface" class="main-interface">
      <div id="toolbar" class="toolbar"></div>
      <div id="desktop" class="desktop"></div>
      <div id="settings-panel" class="settings-panel"></div>
    </div>
  </div>
  
  <!-- External Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <script>
    // Initialize the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // App state
      const state = {
        darkMode: false,
        fontSize: 2,
        highContrast: false,
        currentInspection: null,
        savedInspections: [],
        windows: [],
        nextWindowId: 1,
        zIndex: 100,

        // Default room templates for the "Rooms Management" window drag-and-drop
        defaultRoomTemplates: [
          { name: "Kitchen", condition: 5, notes: "", urgent: false },
          { name: "Living Room", condition: 5, notes: "", urgent: false },
          { name: "Bedroom", condition: 5, notes: "", urgent: false },
          { name: "Bathroom", condition: 5, notes: "", urgent: false },
          { name: "Ensuite", condition: 5, notes: "", urgent: false },
          { name: "Hallway", condition: 5, notes: "", urgent: false },
          { name: "Garden", condition: 5, notes: "", urgent: false },
          { name: "Storage Cupboard", condition: 5, notes: "", urgent: false }
        ]
      };
      
      // DOM Elements
      const elements = {
        app: document.getElementById('app'),
        startScreen: document.getElementById('start-screen'),
        mainInterface: document.getElementById('main-interface'),
        desktop: document.getElementById('desktop'),
        toolbar: document.getElementById('toolbar'),
        settingsPanel: document.getElementById('settings-panel')
      };
      
      // =======================
      // Initialization
      // =======================
      function init() {
        loadStateFromLocalStorage();
        renderStartScreen();
        renderToolbar();
        renderSettingsPanel();
        setupEventListeners();
        playSound('startup');
      }
      
      function loadStateFromLocalStorage() {
        try {
          const savedState = localStorage.getItem('propInspectState');
          if (savedState) {
            const parsedState = JSON.parse(savedState);
            state.darkMode = parsedState.darkMode || false;
            state.fontSize = parsedState.fontSize || 2;
            state.highContrast = parsedState.highContrast || false;
            state.savedInspections = parsedState.savedInspections || [];
          }
          
          if (state.darkMode) {
            document.body.setAttribute('data-theme', 'dark');
          }
          document.body.classList.add(`font-size-${state.fontSize}`);
          if (state.highContrast) {
            document.body.classList.add('high-contrast');
          }
        } catch (error) {
          console.error('Error loading state from localStorage:', error);
        }
      }
      
      function saveStateToLocalStorage() {
        try {
          const stateToSave = {
            darkMode: state.darkMode,
            fontSize: state.fontSize,
            highContrast: state.highContrast,
            savedInspections: state.savedInspections
          };
          localStorage.setItem('propInspectState', JSON.stringify(stateToSave));
        } catch (error) {
          console.error('Error saving state to localStorage:', error);
        }
      }
      
      // =======================
      // Start Screen
      // =======================
      function renderStartScreen() {
        elements.startScreen.innerHTML = `
          <div class="start-screen-content animate-pop">
            <div class="logo">üè† InspectSpace</div>
            <h1>Property Inspection Tool</h1>
            <p>Streamline your property inspections with our intuitive, user-friendly tool.</p>
            
            <div class="form-group" style="margin: 2rem 0;">
              <label class="form-label">Or drag and drop an inspection form file:</label>
              <div id="form-dropzone" class="dropzone">
                <i class="fas fa-file-import" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>Drag and drop your .docx or .txt form here</p>
                <input type="file" id="form-file-input" style="display: none;" accept=".doc,.docx,.txt" />
              </div>
            </div>
            
            <button id="start-inspection-btn" class="start-btn">
              <i class="fas fa-clipboard-check"></i> Begin New Inspection
            </button>
            
            <div class="saved-reports">
              <h3>Saved Inspections</h3>
              <ul class="report-list" id="saved-reports-list">
                ${renderSavedReportsList()}
              </ul>
            </div>
          </div>
        `;
        
        // Start Screen Event Listeners
        document.getElementById('start-inspection-btn').addEventListener('click', startNewInspection);
        
        // Saved Inspections
        document.querySelectorAll('.report-item-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const item = btn.closest('.report-item');
            if (!item) return;
            const reportId = item.dataset.id;
            
            if (btn.classList.contains('load-btn')) {
              loadInspection(reportId);
            } else if (btn.classList.contains('delete-btn')) {
              deleteInspection(reportId);
            }
          });
        });
        document.querySelectorAll('.report-item').forEach(item => {
          item.addEventListener('click', () => {
            const reportId = item.dataset.id;
            loadInspection(reportId);
          });
        });
      }
      
      function renderSavedReportsList() {
        if (!state.savedInspections.length) {
          return '<li class="report-item-empty">No saved inspections found.</li>';
        }
        return state.savedInspections.map(i => `
          <li class="report-item" data-id="${i.id}">
            <div class="report-item-info">
              <div class="report-item-address">${i.propertyAddress}</div>
              <div class="report-item-date">${new Date(i.date).toLocaleDateString()}</div>
            </div>
            <div class="report-item-actions">
              <button class="report-item-btn load-btn" title="Load Inspection">
                <i class="fas fa-folder-open"></i>
              </button>
              <button class="report-item-btn delete-btn" title="Delete Inspection">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </li>
        `).join('');
      }
      
      // =======================
      // Toolbar & Settings
      // =======================
      function renderToolbar() {
        elements.toolbar.innerHTML = `
          <div class="toolbar-title">InspectSpace</div>
          <div class="toolbar-actions">
            <button id="new-inspection-btn" class="toolbar-btn" title="New Inspection">
              <i class="fas fa-plus"></i>
            </button>
            <button id="save-inspection-btn" class="toolbar-btn" title="Save Inspection">
              <i class="fas fa-save"></i>
            </button>
            <button id="export-pdf-btn" class="toolbar-btn" title="Export PDF">
              <i class="fas fa-file-pdf"></i>
            </button>
            <button id="settings-btn" class="toolbar-btn" title="Settings">
              <i class="fas fa-cog"></i>
            </button>
            <button id="home-btn" class="toolbar-btn" title="Return to Home">
              <i class="fas fa-home"></i>
            </button>
          </div>
        `;
      }
      
      function renderSettingsPanel() {
        elements.settingsPanel.innerHTML = `
          <div class="settings-header">
            <h3>Settings</h3>
            <button id="settings-close-btn" class="settings-close">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="settings-section">
            <h4 class="settings-title">Appearance</h4>
            
            <div class="form-group">
              <label class="toggle ${state.darkMode ? 'active' : ''}" id="dark-mode-toggle">
                <span class="toggle-switch"></span>
                Dark Mode
              </label>
            </div>
            
            <div class="form-group">
              <label class="toggle ${state.highContrast ? 'active' : ''}" id="high-contrast-toggle">
                <span class="toggle-switch"></span>
                High Contrast
              </label>
            </div>
            
            <div class="form-group">
              <label class="form-label">Font Size</label>
              <div class="font-size-controls">
                <button id="font-size-decrease" class="canvas-tool">A-</button>
                <button id="font-size-reset" class="canvas-tool">Reset</button>
                <button id="font-size-increase" class="canvas-tool">A+</button>
              </div>
            </div>
          </div>
          
          <div class="settings-section">
            <h4 class="settings-title">About</h4>
            <p>InspectSpace v1.0</p>
            <p>A property inspection tool for letting agents.</p>
            <p>¬© 2025 InspectSpace</p>
          </div>
        `;
      }
      
      function setupEventListeners() {
        // Toolbar
        document.getElementById('new-inspection-btn').addEventListener('click', startNewInspection);
        document.getElementById('save-inspection-btn').addEventListener('click', saveCurrentInspection);
        document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
        document.getElementById('settings-btn').addEventListener('click', toggleSettingsPanel);
        document.getElementById('home-btn').addEventListener('click', returnToHome);
        
        // Settings
        document.getElementById('settings-close-btn').addEventListener('click', toggleSettingsPanel);
        document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);
        document.getElementById('high-contrast-toggle').addEventListener('click', toggleHighContrast);
        document.getElementById('font-size-decrease').addEventListener('click', decreaseFontSize);
        document.getElementById('font-size-reset').addEventListener('click', resetFontSize);
        document.getElementById('font-size-increase').addEventListener('click', increaseFontSize);
        
        // Draggable windows
        interact('.window')
          .draggable({
            allowFrom: '.window-header',
            modifiers: [
              interact.modifiers.restrict({
                restriction: 'parent',
                endOnly: true
              })
            ],
            listeners: {
              move: dragMoveListener,
              start: dragStartListener
            }
          });
        
        // The form dropzone on start screen
        const formDropzone = document.getElementById('form-dropzone');
        const formFileInput = document.getElementById('form-file-input');
        formDropzone.addEventListener('click', () => formFileInput.click());
        formDropzone.addEventListener('dragover', (e) => {
          e.preventDefault();
          formDropzone.classList.add('active');
        });
        formDropzone.addEventListener('dragleave', () => {
          formDropzone.classList.remove('active');
        });
        formDropzone.addEventListener('drop', (e) => {
          e.preventDefault();
          formDropzone.classList.remove('active');
          if (e.dataTransfer.files.length) {
            handleDocxFile(e.dataTransfer.files[0]);
          }
        });
        formFileInput.addEventListener('change', () => {
          if (formFileInput.files.length) {
            handleDocxFile(formFileInput.files[0]);
          }
        });
      }
      
      // Draggable logic
      function dragMoveListener(event) {
        const target = event.target;
        const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
        const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
        
        target.style.transform = `translate(${x}px, ${y}px)`;
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
      }
      function dragStartListener(event) {
        bringWindowToFront(event.target.id);
      }

      // =======================
      // DOCX/TXT Autopopulate
      // =======================
      async function handleDocxFile(file) {
        if (!file) return;
        let text = "";
        const fn = file.name.toLowerCase();
        try {
          if (fn.endsWith('.docx') || fn.endsWith('.doc')) {
            const ab = await file.arrayBuffer();
            const result = await window.mammoth.extractRawText({ arrayBuffer: ab });
            text = result.value;
          } else if (fn.endsWith('.txt')) {
            text = await file.text();
          } else {
            alert("Unsupported file type. Please use .docx or .txt");
            return;
          }
        } catch (err) {
          console.warn("Failed to parse docx with mammoth, fallback to text. Error:", err);
          text = await file.text();
        }
        populateInspectionFromDocText(text);
      }

      function populateInspectionFromDocText(text) {
        if (!state.currentInspection) {
          startNewInspection(true); // pass a "skip" to avoid double window?
        }
        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        lines.forEach(line => {
          if (line.startsWith("Property:")) {
            const val = line.replace("Property:", "").trim();
            state.currentInspection.propertyAddress = val;
          }
          if (line.startsWith("Tenants:")) {
            const val = line.replace("Tenants:", "").trim();
            state.currentInspection.tenantName = val;
          }
          if (line.startsWith("Tenancy Start Date:")) {
            const val = line.replace("Tenancy Start Date:", "").trim();
            state.currentInspection.date = val;
          }
        });
        alert("Form file parsed! Inspection details have been auto-filled.");
        
        // If user is on start screen, jump them to main
        elements.startScreen.classList.remove('active');
        elements.mainInterface.classList.add('active');
        
        // If we already have property address from doc, skip property screen:
        if (state.currentInspection.propertyAddress) {
          createRoomsManagementWindow();
        } else {
          createPropertyDetailsWindow();
        }
      }

      // =======================
      // Inspections
      // =======================
      function startNewInspection(skipWindow) {
        // Create a new blank
        state.currentInspection = {
          id: generateId(),
          date: new Date().toISOString(),
          propertyAddress: "",
          agentName: "",
          tenantName: "",
          rooms: [],
          tenantSignature: "",
          agentSignature: ""
        };
        // Switch
        elements.startScreen.classList.remove('active');
        elements.mainInterface.classList.add('active');
        
        // If skipWindow is true, do not open property details yet
        if (!skipWindow) {
          createPropertyDetailsWindow();
        }
        playSound('window-open');
      }

      function createPropertyDetailsWindow() {
        const windowId = `window-property-${state.nextWindowId++}`;
        const wHtml = `
          <div id="${windowId}" class="window" style="top: 50px; left: 50px; width: 500px;">
            <div class="window-header">
              <div class="window-title">Property Details</div>
              <div class="window-controls">
                <div class="window-control window-close" data-window="${windowId}"></div>
                <div class="window-control window-minimize" data-window="${windowId}"></div>
                <div class="window-control window-maximize" data-window="${windowId}"></div>
              </div>
            </div>
            <div class="window-content">
              <form id="property-form">
                <div class="form-group">
                  <label class="form-label" for="property-address">Property Address</label>
                  <input type="text" id="property-address" class="form-input" required value="${state.currentInspection.propertyAddress}">
                </div>
                <div class="form-group">
                  <label class="form-label" for="inspection-date">Inspection Date</label>
                  <input type="date" id="inspection-date" class="form-input" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="agent-name">Agent Name</label>
                  <input type="text" id="agent-name" class="form-input" required value="${state.currentInspection.agentName}">
                </div>
                <div class="form-group">
                  <label class="form-label" for="tenant-name">Tenant Name</label>
                  <input type="text" id="tenant-name" class="form-input" required value="${state.currentInspection.tenantName}">
                </div>
                <button type="submit" class="start-btn">Continue to Inspection</button>
              </form>
            </div>
          </div>
        `;
        elements.desktop.insertAdjacentHTML('beforeend', wHtml);
        
        const wEl = document.getElementById(windowId);
        wEl.querySelector('.window-close').addEventListener('click', () => closeWindow(windowId));
        wEl.querySelector('.window-minimize').addEventListener('click', () => minimizeWindow(windowId));
        wEl.querySelector('.window-maximize').addEventListener('click', () => maximizeWindow(windowId));
        
        // Pre-fill date
        const form = wEl.querySelector('#property-form');
        const dateInput = form.querySelector('#inspection-date');
        let d = new Date(state.currentInspection.date);
        if (!isNaN(d.getTime())) {
          dateInput.value = d.toISOString().split('T')[0];
        } else {
          dateInput.value = new Date().toISOString().split('T')[0];
        }

        form.addEventListener('submit', (e) => {
          e.preventDefault();
          state.currentInspection.propertyAddress = form.querySelector('#property-address').value;
          state.currentInspection.date = form.querySelector('#inspection-date').value;
          state.currentInspection.agentName = form.querySelector('#agent-name').value;
          state.currentInspection.tenantName = form.querySelector('#tenant-name').value;
          closeWindow(windowId);
          createRoomsManagementWindow();
        });
        
        state.windows.push(windowId);
        bringWindowToFront(windowId);
        wEl.classList.add('animate-pop');
      }

      function createRoomsManagementWindow() {
        const windowId = `window-rooms-${state.nextWindowId++}`;
        const wHtml = `
          <div id="${windowId}" class="window" style="top: 80px; left: 80px; width: 700px;">
            <div class="window-header">
              <div class="window-title">Rooms Management</div>
              <div class="window-controls">
                <div class="window-control window-close" data-window="${windowId}"></div>
                <div class="window-control window-minimize" data-window="${windowId}"></div>
                <div class="window-control window-maximize" data-window="${windowId}"></div>
              </div>
            </div>
            <div class="window-content">
              <h3>Property: ${state.currentInspection.propertyAddress}</h3>
              <p>Add rooms to inspect or drag a template from the right onto your list.</p>
              
              <div class="template-area">
                <ul id="room-list" class="room-list">
                  ${renderRoomsList()}
                </ul>
                
                <div class="template-palette" id="template-palette">
                  <h4 style="margin-bottom: 0.5rem;">Room Templates</h4>
                  ${state.defaultRoomTemplates.map((tpl, idx) => `
                    <div class="template-item" data-tid="${idx}" draggable="true">
                      ${tpl.name}
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label" for="new-room-name">Add New Room</label>
                <div style="display: flex; gap: 10px;">
                  <input type="text" id="new-room-name" class="form-input" placeholder="e.g. Kitchen, Bedroom 1">
                  <button id="add-room-btn" class="add-room">
                    <i class="fas fa-plus"></i> Add
                  </button>
                </div>
              </div>
              
              <div class="form-group" style="margin-top: 20px;">
                <button id="signatures-btn" class="start-btn">Proceed to Signatures</button>
              </div>
            </div>
          </div>
        `;
        elements.desktop.insertAdjacentHTML('beforeend', wHtml);
        
        const wEl = document.getElementById(windowId);
        wEl.querySelector('.window-close').addEventListener('click', () => closeWindow(windowId));
        wEl.querySelector('.window-minimize').addEventListener('click', () => minimizeWindow(windowId));
        wEl.querySelector('.window-maximize').addEventListener('click', () => maximizeWindow(windowId));
        
        // Add new room
        const addBtn = wEl.querySelector('#add-room-btn');
        addBtn.addEventListener('click', addNewRoom);

        // Signatures
        wEl.querySelector('#signatures-btn').addEventListener('click', createSignaturesWindow);

        // Drag-and-drop for templates
        setupTemplateDragAndDrop(wEl);

        state.windows.push(windowId);
        bringWindowToFront(windowId);
        wEl.classList.add('animate-pop');
        playSound('window-open');
        
        // Room item clicks
        const roomListEl = wEl.querySelector('#room-list');
        roomListEl.addEventListener('click', (e) => {
          const t = e.target;
          if (!t) return;
          
          if (t.classList.contains('room-name') || t.parentElement.classList.contains('room-item')) {
            const item = t.closest('.room-item');
            if (!item) return;
            createRoomInspectionWindow(item.dataset.id);
          }
          if (t.classList.contains('edit-btn') || t.parentElement.classList.contains('edit-btn')) {
            const item = t.closest('.room-item');
            createRoomInspectionWindow(item.dataset.id);
            e.stopPropagation();
          }
          if (t.classList.contains('delete-btn') || t.parentElement.classList.contains('delete-btn')) {
            const item = t.closest('.room-item');
            deleteRoom(item.dataset.id);
            e.stopPropagation();
          }
        });
      }

      function renderRoomsList() {
        if (!state.currentInspection?.rooms?.length) {
          return '<li class="room-item-empty">No rooms added yet.</li>';
        }
        return state.currentInspection.rooms.map(r => `
          <li class="room-item ${r.urgent ? 'urgent' : ''}" data-id="${r.id}">
            <div class="room-name">${r.name}</div>
            <div class="room-actions">
              <button class="room-btn edit-btn"><i class="fas fa-edit"></i></button>
              <button class="room-btn delete-btn"><i class="fas fa-trash"></i></button>
            </div>
          </li>
        `).join('');
      }

      function addNewRoom() {
        const inp = document.getElementById('new-room-name');
        const val = (inp?.value || "").trim();
        if (!val) {
          inp.classList.add('animate-shake');
          setTimeout(() => inp.classList.remove('animate-shake'), 300);
          return;
        }
        const newRoom = {
          id: generateId(),
          name: val,
          condition: 5,
          notes: "",
          photos: [],
          urgent: false
        };
        state.currentInspection.rooms.push(newRoom);
        document.getElementById('room-list').innerHTML = renderRoomsList();
        inp.value = "";
        playSound('pop');
        createRoomInspectionWindow(newRoom.id);
      }

      function setupTemplateDragAndDrop(containerEl) {
        const palette = containerEl.querySelector('#template-palette');
        const roomListEl = containerEl.querySelector('#room-list');

        // Make each .template-item draggable with Interact or HTML5
        palette.querySelectorAll('.template-item').forEach(item => {
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/templateId', item.dataset.tid);
          });
        });

        // Drop events on #room-list
        roomListEl.addEventListener('dragover', (e) => {
          e.preventDefault();
          roomListEl.classList.add('drag-over');
        });
        roomListEl.addEventListener('dragleave', () => {
          roomListEl.classList.remove('drag-over');
        });
        roomListEl.addEventListener('drop', (e) => {
          e.preventDefault();
          roomListEl.classList.remove('drag-over');
          const tid = e.dataTransfer.getData('text/templateId');
          if (tid !== "") {
            const tpl = state.defaultRoomTemplates[parseInt(tid, 10)];
            if (tpl) {
              // create a new room
              const newRoom = {
                id: generateId(),
                name: tpl.name,
                condition: tpl.condition,
                notes: tpl.notes,
                photos: [],
                urgent: tpl.urgent
              };
              state.currentInspection.rooms.push(newRoom);
              roomListEl.innerHTML = renderRoomsList();
              playSound('pop');
            }
          }
        });
      }

      function deleteRoom(roomId) {
        const idx = state.currentInspection.rooms.findIndex(r => r.id === roomId);
        if (idx !== -1) {
          state.currentInspection.rooms.splice(idx, 1);
          const listEl = document.getElementById('room-list');
          if (listEl) listEl.innerHTML = renderRoomsList();
          playSound('trash');
        }
      }

      function createRoomInspectionWindow(roomId) {
        const room = state.currentInspection.rooms.find(r => r.id === roomId);
        if (!room) return;
        
        const windowId = `window-room-${roomId}-${state.nextWindowId++}`;
        const wHtml = `
          <div id="${windowId}" class="window" style="top: 100px; left: 200px; width: 650px;">
            <div class="window-header">
              <div class="window-title">Room Inspection: ${room.name}</div>
              <div class="window-controls">
                <div class="window-control window-close" data-window="${windowId}"></div>
                <div class="window-control window-minimize" data-window="${windowId}"></div>
                <div class="window-control window-maximize" data-window="${windowId}"></div>
              </div>
            </div>
            <div class="window-content">
              <div class="form-group">
                <label class="form-label" for="room-condition-${roomId}">Condition Rating (1-10)</label>
                <div class="rating">
                  <input type="range" id="room-condition-${roomId}" class="rating-slider" min="1" max="10" value="${room.condition}">
                  <div class="rating-value" id="room-condition-value-${roomId}">${room.condition}/10</div>
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label" for="room-notes-${roomId}">Notes</label>
                <textarea id="room-notes-${roomId}" class="form-textarea">${room.notes}</textarea>
              </div>
              
              <div class="form-group">
                <label class="form-label">Photos</label>
                <div class="dropzone" id="dropzone-${roomId}">
                  <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 10px;"></i>
                  <p>Drag and drop photos here or click to select files</p>
                  <input type="file" id="file-input-${roomId}" style="display: none;" accept="image/*" multiple>
                </div>
                <div id="photo-previews-${roomId}" class="photo-previews">
                  ${renderPhotoPreviewsHtml(room.photos)}
                </div>
              </div>
              
              <div class="form-group">
                <label class="toggle ${room.urgent ? 'active' : ''}" id="urgent-toggle-${roomId}">
                  <span class="toggle-switch"></span>
                  Mark as Urgent Issue
                </label>
              </div>
              
              <button id="save-room-btn-${roomId}" class="start-btn">Save Room Inspection</button>
            </div>
          </div>
        `;
        elements.desktop.insertAdjacentHTML('beforeend', wHtml);
        
        const wEl = document.getElementById(windowId);
        wEl.querySelector('.window-close').addEventListener('click', () => closeWindow(windowId));
        wEl.querySelector('.window-minimize').addEventListener('click', () => minimizeWindow(windowId));
        wEl.querySelector('.window-maximize').addEventListener('click', () => maximizeWindow(windowId));

        // Condition slider
        const slider = wEl.querySelector(`#room-condition-${roomId}`);
        const valEl = wEl.querySelector(`#room-condition-value-${roomId}`);
        slider.addEventListener('input', () => {
          valEl.textContent = `${slider.value}/10`;
        });

        // Urgent toggle
        const urgentToggle = wEl.querySelector(`#urgent-toggle-${roomId}`);
        urgentToggle.addEventListener('click', () => {
          urgentToggle.classList.toggle('active');
        });

        // Photos
        const dz = wEl.querySelector(`#dropzone-${roomId}`);
        const fi = wEl.querySelector(`#file-input-${roomId}`);
        dz.addEventListener('click', () => fi.click());
        dz.addEventListener('dragover', (e) => {
          e.preventDefault();
          dz.classList.add('active');
        });
        dz.addEventListener('dragleave', () => dz.classList.remove('active'));
        dz.addEventListener('drop', (e) => {
          e.preventDefault();
          dz.classList.remove('active');
          if (e.dataTransfer.files.length) {
            handleRoomPhotos(e.dataTransfer.files, room);
          }
        });
        fi.addEventListener('change', () => {
          if (fi.files.length) {
            handleRoomPhotos(fi.files, room);
          }
        });

        wEl.querySelector(`#save-room-btn-${roomId}`).addEventListener('click', () => {
          room.condition = parseInt(slider.value);
          room.notes = wEl.querySelector(`#room-notes-${roomId}`).value;
          room.urgent = urgentToggle.classList.contains('active');
          const list = document.getElementById('room-list');
          if (list) list.innerHTML = renderRoomsList();
          closeWindow(windowId);
          playSound('save');
        });
        
        state.windows.push(windowId);
        bringWindowToFront(windowId);
        wEl.classList.add('animate-pop');
        playSound('window-open');
      }

      function handleRoomPhotos(files, room) {
        Array.from(files).forEach(file => {
          if (!file.type.match('image.*')) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            const pid = generateId();
            room.photos.push({
              id: pid,
              data: e.target.result,
              name: file.name
            });
            // Update previews if the window is open
            const previewEl = document.getElementById(`photo-previews-${room.id}`);
            if (previewEl) {
              previewEl.innerHTML = renderPhotoPreviewsHtml(room.photos);
              previewEl.querySelectorAll('.photo-delete-btn').forEach(btn => {
                btn.addEventListener('click', (ev) => {
                  const pId = ev.currentTarget.dataset.id;
                  deletePhoto(room, pId);
                });
              });
            }
            playSound('camera');
          };
          reader.readAsDataURL(file);
        });
      }

      function renderPhotoPreviewsHtml(photos) {
        if (!photos?.length) {
          return '<p>No photos added yet.</p>';
        }
        return `
          <div class="photo-grid">
            ${photos.map(photo => `
              <div class="photo-item">
                <img src="${photo.data}" alt="${photo.name}" class="image-preview">
                <button class="photo-delete-btn" data-id="${photo.id}">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            `).join('')}
          </div>
        `;
      }

      function deletePhoto(room, photoId) {
        const idx = room.photos.findIndex(p => p.id === photoId);
        if (idx !== -1) {
          room.photos.splice(idx, 1);
          const previewEl = document.getElementById(`photo-previews-${room.id}`);
          if (previewEl) {
            previewEl.innerHTML = renderPhotoPreviewsHtml(room.photos);
            previewEl.querySelectorAll('.photo-delete-btn').forEach(btn => {
              btn.addEventListener('click', (ev) => {
                const pId = ev.currentTarget.dataset.id;
                deletePhoto(room, pId);
              });
            });
          }
          playSound('trash');
        }
      }

      // =======================
      // Signatures
      // =======================
      function createSignaturesWindow() {
        const windowId = `window-signatures-${state.nextWindowId++}`;
        const wHtml = `
          <div id="${windowId}" class="window" style="top: 120px; left: 150px; width: 700px;">
            <div class="window-header">
              <div class="window-title">Signatures</div>
              <div class="window-controls">
                <div class="window-control window-close" data-window="${windowId}"></div>
                <div class="window-control window-minimize" data-window="${windowId}"></div>
                <div class="window-control window-maximize" data-window="${windowId}"></div>
              </div>
            </div>
            <div class="window-content">
              <h3>Property: ${state.currentInspection.propertyAddress}</h3>
              <p>Please sign below to confirm the inspection details.</p>
              
              <div class="form-group">
                <label class="form-label">Tenant Signature</label>
                <canvas id="tenant-signature" class="signature-canvas" width="600" height="150"></canvas>
                <div class="canvas-tools">
                  <button id="tenant-clear-btn" class="canvas-tool">Clear</button>
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">Agent Signature</label>
                <canvas id="agent-signature" class="signature-canvas" width="600" height="150"></canvas>
                <div class="canvas-tools">
                  <button id="agent-clear-btn" class="canvas-tool">Clear</button>
                </div>
              </div>
              
              <div class="form-group">
                <button id="complete-inspection-btn" class="start-btn">Complete Inspection</button>
                <button id="skip-signatures-btn" class="start-btn" style="background-color: #ccc; color: #333;">
                  Skip Signatures
                </button>
              </div>
            </div>
          </div>
        `;
        elements.desktop.insertAdjacentHTML('beforeend', wHtml);
        
        const wEl = document.getElementById(windowId);
        wEl.querySelector('.window-close').addEventListener('click', () => closeWindow(windowId));
        wEl.querySelector('.window-minimize').addEventListener('click', () => minimizeWindow(windowId));
        wEl.querySelector('.window-maximize').addEventListener('click', () => maximizeWindow(windowId));
        
        setupSignatureCanvas('tenant-signature', 'tenant-clear-btn');
        setupSignatureCanvas('agent-signature', 'agent-clear-btn');
        
        wEl.querySelector('#complete-inspection-btn').addEventListener('click', completeInspection);
        wEl.querySelector('#skip-signatures-btn').addEventListener('click', () => {
          // Skip
          closeWindow(windowId);
          createSummaryWindow();
        });

        state.windows.push(windowId);
        bringWindowToFront(windowId);
        wEl.classList.add('animate-pop');
        playSound('window-open');
      }

      function setupSignatureCanvas(canvasId, clearBtnId) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#000000';
        
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        canvas.addEventListener('touchstart', startDrawingTouch, { passive: false });
        canvas.addEventListener('touchmove', drawTouch, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);

        document.getElementById(clearBtnId).addEventListener('click', () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
        
        function startDrawing(e) {
          isDrawing = true;
          [lastX, lastY] = [e.offsetX, e.offsetY];
        }
        function draw(e) {
          if (!isDrawing) return;
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(e.offsetX, e.offsetY);
          ctx.stroke();
          [lastX, lastY] = [e.offsetX, e.offsetY];
        }
        function stopDrawing() {
          isDrawing = false;
        }
        function startDrawingTouch(e) {
          e.preventDefault();
          isDrawing = true;
          const rect = canvas.getBoundingClientRect();
          const t = e.touches[0];
          [lastX, lastY] = [t.clientX - rect.left, t.clientY - rect.top];
        }
        function drawTouch(e) {
          if (!isDrawing) return;
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          const t = e.touches[0];
          const x = t.clientX - rect.left;
          const y = t.clientY - rect.top;
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(x, y);
          ctx.stroke();
          [lastX, lastY] = [x, y];
        }
      }

      function completeInspection() {
        // Save the signature
        const tenantSigCanvas = document.getElementById('tenant-signature');
        const agentSigCanvas = document.getElementById('agent-signature');
        if (tenantSigCanvas && agentSigCanvas) {
          state.currentInspection.tenantSignature = tenantSigCanvas.toDataURL();
          state.currentInspection.agentSignature = agentSigCanvas.toDataURL();
        }
        saveCurrentInspection();
        createSummaryWindow();
        playSound('success');
      }

      // =======================
      // Summary Window
      // =======================
      function createSummaryWindow() {
        const windowId = `window-summary-${state.nextWindowId++}`;
        const wHtml = `
          <div id="${windowId}" class="window" style="top: 50px; left: 100px; width: 700px;">
            <div class="window-header">
              <div class="window-title">Inspection Summary</div>
              <div class="window-controls">
                <div class="window-control window-close" data-window="${windowId}"></div>
                <div class="window-control window-minimize" data-window="${windowId}"></div>
                <div class="window-control window-maximize" data-window="${windowId}"></div>
              </div>
            </div>
            <div class="window-content">
              <h2>Inspection Completed!</h2>
              <p>Property: ${state.currentInspection.propertyAddress}</p>
              <p>Date: ${new Date(state.currentInspection.date).toLocaleDateString()}</p>
              <p>Agent: ${state.currentInspection.agentName}</p>
              <p>Tenant: ${state.currentInspection.tenantName}</p>
              
              <h3>Rooms Inspected: ${state.currentInspection.rooms.length}</h3>
              <ul class="summary-list">
                ${state.currentInspection.rooms.map(room => `
                  <li class="summary-item ${room.urgent ? 'urgent' : ''}">
                    <strong>${room.name}</strong> - Condition: ${room.condition}/10
                    ${room.urgent ? '<span class="urgent-badge">URGENT</span>' : ''}
                  </li>
                `).join('')}
              </ul>
              
              <div class="form-group" style="margin-top: 20px; display: flex; gap: 10px;">
                <button id="export-pdf-summary-btn" class="start-btn">
                  <i class="fas fa-file-pdf"></i> Export PDF
                </button>
                <button id="generate-qr-btn" class="start-btn">
                  <i class="fas fa-qrcode"></i> Generate QR Code
                </button>
                <button id="return-home-btn" class="start-btn">
                  <i class="fas fa-home"></i> Return to Home
                </button>
              </div>
              
              <div id="qrcode-container" style="margin-top: 20px; text-align: center; display: none;"></div>
            </div>
          </div>
        `;
        elements.desktop.insertAdjacentHTML('beforeend', wHtml);
        
        const wEl = document.getElementById(windowId);
        wEl.querySelector('.window-close').addEventListener('click', () => closeWindow(windowId));
        wEl.querySelector('.window-minimize').addEventListener('click', () => minimizeWindow(windowId));
        wEl.querySelector('.window-maximize').addEventListener('click', () => maximizeWindow(windowId));
        
        wEl.querySelector('#export-pdf-summary-btn').addEventListener('click', exportToPDF);
        wEl.querySelector('#generate-qr-btn').addEventListener('click', generateQRCode);
        wEl.querySelector('#return-home-btn').addEventListener('click', returnToHome);

        state.windows.push(windowId);
        bringWindowToFront(windowId);
        wEl.classList.add('animate-pop');
        playSound('window-open');
      }

      function generateQRCode() {
        const qrContainer = document.getElementById('qrcode-container');
        qrContainer.style.display = 'block';
        qrContainer.innerHTML = '';
        
        const data = {
          id: state.currentInspection.id,
          propertyAddress: state.currentInspection.propertyAddress,
          date: state.currentInspection.date
        };
        const dataUrl = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(data))}`;
        new QRCode(qrContainer, { text: dataUrl, width: 200, height: 200 });
        playSound('pop');
      }

      // =======================
      // Save/Load
      // =======================
      function saveCurrentInspection() {
        if (!state.currentInspection) return;
        const idx = state.savedInspections.findIndex(i => i.id === state.currentInspection.id);
        if (idx !== -1) {
          state.savedInspections[idx] = { ...state.currentInspection };
        } else {
          state.savedInspections.push({ ...state.currentInspection });
        }
        saveStateToLocalStorage();
        playSound('save');
      }

      function loadInspection(inspectionId) {
        const found = state.savedInspections.find(i => i.id === inspectionId);
        if (!found) return;
        state.currentInspection = { ...found };
        
        elements.startScreen.classList.remove('active');
        elements.mainInterface.classList.add('active');
        createRoomsManagementWindow();
        playSound('window-open');
      }

      function deleteInspection(inspectionId) {
        const idx = state.savedInspections.findIndex(i => i.id === inspectionId);
        if (idx !== -1) {
          state.savedInspections.splice(idx, 1);
          saveStateToLocalStorage();
          // re-render
          const listEl = document.getElementById('saved-reports-list');
          if (listEl) {
            listEl.innerHTML = renderSavedReportsList();
          }
          playSound('trash');
        }
      }

      // =======================
      // PDF Export
      // =======================
      function exportToPDF() {
        if (!state.currentInspection) return;
        const pdfWindowId = `window-pdf-${state.nextWindowId++}`;
        const wHtml = `
          <div id="${pdfWindowId}" class="window" style="top: 50px; left: 50px; width: 800px; height: 600px;">
            <div class="window-header">
              <div class="window-title">Generating PDF...</div>
              <div class="window-controls">
                <div class="window-control window-close" data-window="${pdfWindowId}"></div>
              </div>
            </div>
            <div class="window-content">
              <div id="pdf-content" style="padding: 20px; background-color: white;">
                <div style="text-align: center; margin-bottom: 20px;">
                  <h1 style="color: #3b82f6;">InspectSpace</h1>
                  <h2>Property Inspection Report</h2>
                </div>
                
                <div style="margin-bottom: 30px;">
                  <h3>Property Details</h3>
                  <p><strong>Address:</strong> ${state.currentInspection.propertyAddress}</p>
                  <p><strong>Inspection Date:</strong> ${new Date(state.currentInspection.date).toLocaleDateString()}</p>
                  <p><strong>Agent:</strong> ${state.currentInspection.agentName}</p>
                  <p><strong>Tenant:</strong> ${state.currentInspection.tenantName}</p>
                </div>
                
                <div style="margin-bottom: 30px;">
                  <h3>Room Inspections</h3>
                  ${
                    state.currentInspection.rooms.map(r => `
                      <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; ${r.urgent ? 'border-left: 5px solid #ef4444;' : ''}">
                        <h4>${r.name} ${r.urgent ? '<span style="color: #ef4444;">(URGENT)</span>' : ''}</h4>
                        <p><strong>Condition:</strong> ${r.condition}/10</p>
                        <p><strong>Notes:</strong> ${r.notes || 'No notes provided.'}</p>
                        ${
                          r.photos?.length
                            ? `
                              <div>
                                <p><strong>Photos:</strong></p>
                                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                  ${r.photos.map(p => `
                                    <img src="${p.data}" alt="${p.name}" style="max-width: 200px; max-height: 150px; border-radius: 5px;">
                                  `).join('')}
                                </div>
                              </div>
                            `
                            : '<p><strong>Photos:</strong> No photos provided.</p>'
                        }
                      </div>
                    `).join('')
                  }
                </div>
                
                <div style="margin-bottom: 30px;">
                  <h3>Signatures</h3>
                  <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                    <div style="flex: 1; min-width: 300px;">
                      <p><strong>Tenant Signature:</strong></p>
                      ${
                        state.currentInspection.tenantSignature
                          ? `<img src="${state.currentInspection.tenantSignature}" alt="Tenant Signature" style="max-width: 100%; border: 1px solid #d1d5db; border-radius: 5px;">`
                          : '<p>No signature provided.</p>'
                      }
                    </div>
                    <div style="flex: 1; min-width: 300px;">
                      <p><strong>Agent Signature:</strong></p>
                      ${
                        state.currentInspection.agentSignature
                          ? `<img src="${state.currentInspection.agentSignature}" alt="Agent Signature" style="max-width: 100%; border: 1px solid #d1d5db; border-radius: 5px;">`
                          : '<p>No signature provided.</p>'
                      }
                    </div>
                  </div>
                </div>
                
                <div style="text-align: center; margin-top: 50px; color: #6b7280; font-size: 0.8rem;">
                  <p>Generated by InspectSpace - ${new Date().toLocaleDateString()}</p>
                </div>
              </div>
            </div>
          </div>
        `;
        elements.desktop.insertAdjacentHTML('beforeend', wHtml);
        
        state.windows.push(pdfWindowId);
        bringWindowToFront(pdfWindowId);
        
        document.querySelector(`#${pdfWindowId} .window-close`).addEventListener('click', () => closeWindow(pdfWindowId));
        
        setTimeout(() => {
          const el = document.getElementById('pdf-content');
          const opt = {
            margin: 10,
            filename: `InspectSpace_${(state.currentInspection.propertyAddress || '').replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
          };
          html2pdf().set(opt).from(el).save().then(() => {
            const titleEl = document.querySelector(`#${pdfWindowId} .window-title`);
            if (titleEl) titleEl.textContent = 'PDF Generated';
            playSound('success');
          });
        }, 1000);
      }

      function returnToHome() {
        closeAllWindows();
        elements.mainInterface.classList.remove('active');
        elements.startScreen.classList.add('active');
        state.currentInspection = null;
        playSound('back');
      }

      // =======================
      // Toggle Settings
      // =======================
      function toggleSettingsPanel() {
        elements.settingsPanel.classList.toggle('active');
        playSound('click');
      }

      function toggleDarkMode() {
        state.darkMode = !state.darkMode;
        document.getElementById('dark-mode-toggle').classList.toggle('active', state.darkMode);
        document.body.setAttribute('data-theme', state.darkMode ? 'dark' : 'light');
        saveStateToLocalStorage();
        playSound('click');
      }
      
      function toggleHighContrast() {
        state.highContrast = !state.highContrast;
        document.getElementById('high-contrast-toggle').classList.toggle('active', state.highContrast);
        document.body.classList.toggle('high-contrast', state.highContrast);
        saveStateToLocalStorage();
        playSound('click');
      }

      function decreaseFontSize() {
        if (state.fontSize > 1) {
          document.body.classList.remove(`font-size-${state.fontSize}`);
          state.fontSize--;
          document.body.classList.add(`font-size-${state.fontSize}`);
          saveStateToLocalStorage();
          playSound('click');
        }
      }
      function resetFontSize() {
        document.body.classList.remove(`font-size-${state.fontSize}`);
        state.fontSize = 2;
        document.body.classList.add(`font-size-${state.fontSize}`);
        saveStateToLocalStorage();
        playSound('click');
      }
      function increaseFontSize() {
        if (state.fontSize < 3) {
          document.body.classList.remove(`font-size-${state.fontSize}`);
          state.fontSize++;
          document.body.classList.add(`font-size-${state.fontSize}`);
          saveStateToLocalStorage();
          playSound('click');
        }
      }

      // =======================
      // Windows & Helpers
      // =======================
      function closeWindow(windowId) {
        const w = document.getElementById(windowId);
        if (!w) return;
        w.classList.add('animate-pop');
        w.style.opacity = 0;
        w.style.transform = 'scale(0.9)';
        setTimeout(() => {
          w.remove();
          const i = state.windows.indexOf(windowId);
          if (i !== -1) state.windows.splice(i, 1);
        }, 300);
        playSound('window-close');
      }
      function minimizeWindow(windowId) {
        const w = document.getElementById(windowId);
        if (!w) return;
        w.classList.toggle('minimized');
        if (w.classList.contains('minimized')) {
          w.setAttribute('data-prev-height', w.style.height || 'auto');
          w.setAttribute('data-prev-width', w.style.width || 'auto');
          w.setAttribute('data-prev-top', w.style.top || '0');
          w.setAttribute('data-prev-left', w.style.left || '0');
          w.style.height = '40px';
          w.style.width = '200px';
          w.style.top = 'calc(100% - 50px)';
          const offset = state.windows.indexOf(windowId) * 210;
          w.style.left = `${offset}px`;
          
          const c = w.querySelector('.window-content');
          if (c) c.style.display = 'none';
        } else {
          w.style.height = w.getAttribute('data-prev-height');
          w.style.width = w.getAttribute('data-prev-width');
          w.style.top = w.getAttribute('data-prev-top');
          w.style.left = w.getAttribute('data-prev-left');
          const c = w.querySelector('.window-content');
          if (c) c.style.display = 'block';
        }
        playSound('click');
      }
      function maximizeWindow(windowId) {
        const w = document.getElementById(windowId);
        if (!w) return;
        w.classList.toggle('maximized');
        if (w.classList.contains('maximized')) {
          w.setAttribute('data-prev-height', w.style.height || 'auto');
          w.setAttribute('data-prev-width', w.style.width || 'auto');
          w.setAttribute('data-prev-top', w.style.top || '0');
          w.setAttribute('data-prev-left', w.style.left || '0');
          w.style.height = 'calc(100% - 50px)';
          w.style.width = '100%';
          w.style.top = '0';
          w.style.left = '0';
        } else {
          w.style.height = w.getAttribute('data-prev-height');
          w.style.width = w.getAttribute('data-prev-width');
          w.style.top = w.getAttribute('data-prev-top');
          w.style.left = w.getAttribute('data-prev-left');
        }
        playSound('click');
      }
      function closeAllWindows() {
        [...state.windows].forEach(winId => closeWindow(winId));
      }
      function bringWindowToFront(windowId) {
        const w = document.getElementById(windowId);
        if (!w) return;
        state.zIndex++;
        w.style.zIndex = state.zIndex;
        state.windows.forEach(id => {
          const w2 = document.getElementById(id);
          if (w2) w2.classList.remove('active');
        });
        w.classList.add('active');
      }

      // Helpers
      function generateId() {
        return '_' + Math.random().toString(36).substr(2, 9);
      }
      function playSound(type) {
        // Placeholder
      }
      
      // Start
      init();
    });
  </script>
</body>
</html>
